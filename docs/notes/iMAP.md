---
head:
  - - link
    - rel: stylesheet
      href: https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css
---
# 实时隐式映射与定位

这篇文章简单的介绍一下实时隐式映射与定位（iMAP），主要根据[论文](https://arxiv.org/abs/2103.12352)和[知乎文章](https://zhuanlan.zhihu.com/p/487702125)。

## NeRF 简介

在介绍 iMAP 之前，我们先简单介绍一下 NeRF ，因为我们认为 iMAP 与 NeRF 有着密切的关系，理解 NeRF 对于理解 iMAP 有着重要的作用。这部分参考[论文](https://arxiv.org/abs/2003.08934)。

### 简介

NeRF 即神经辐射场，可以用来表示场景。在传统的计算机视觉和图形学中，常用的场景表示有点云表示、三角网格表示、体素表示等，一般都为离散的，对于解决新视角下物体等问题并不方便，且存储往往需要较大的空间；神经辐射场，则提出了一种连续的表达场景的方法，将场景建模为一个从三维坐标和视角方向到 RGB 颜色和体密度的映射，这个映射用 MLP 实现。

### 技术细节

关于其技术细节，这里简要介绍以下内容，参考了[书籍《三维视觉新范式：深度解析NeRF与3DGS技术》](https://book.douban.com/subject/37014639/)。

#### 位置编码

上面提到的 MLP 网络其输入一般不是直接的所提到的三维坐标和视角方向，而会拼接上其位置编码的输出，编码方法有许多，论文作者的方法包括从三维坐标和视角方向（拼接作一个向量）进行正余弦频域位置编码，而后续的发展则导致了更多的频域增其那个的方法。

#### MLP 网络结构

经过位置编码处理后，得到的输入特征会经过一个 MLP 网络，论文作者使用的是一个十层的全连接网络，并于第 $5$ 层与三维坐标的输入特征拼接，而第 $8$ 层的最后不再经过激活函数，直接进入下一层，第 $9$ 层则输出密度值，并联接方向信息，最后一层输出 RGB 颜色值。

#### 粗糙网络与精细网络

从粗糙到精细是计算机视觉中十分常用的一种方法。 NeRF 算法设计了分层采样的方法，设置粗糙网络和精细网络，以因应空间点分布的稀疏性。简单的介绍， NeRF 的粗糙网络通过均匀的采样得到空间点分布的先验，而精细网络因应于此在采样时对那些对渲染结果影响较大的区域进行更稠密的采样，训练阶段计算损失函数需要同时考虑两个网络的损失，以它们的加权和为总的损失。

#### 体渲染技术

通过 MLP 网络，我们可以查到任一视角观察任一三维点的颜色和体密度，所谓体渲染，即根据这些信息渲染得到图片。从理论的角度，我们可以通过沿光心发出的过像素的射线的积分得到，颜色表征射线上一处的强度，而其之前的体密度决定了其系数，从实际应用的角度，我们可以通过在射线上采样若干个点求解，考虑到三维点大部分为空白，我们可以使用从粗糙到精细的方法采样。

顺便一提的是，这里的体渲染构成了 NeRF 十分关键的一点，其突出的特征就是这个渲染过程是可微的，这使得后续的优化成为可能。

#### 损失计算与优化

我们通过优化的方法取得场景的 MLP 表示，损失的计算基于渲染图像与真值图的光度误差，优化的方法一般可以使用梯度下降，而梯度的计算必然要求过程是可微的，这正是上面强调我们的体渲染技术是可微的缘故。

## iMAP 简介

### 简介

我们先从较高的层次来看， iMAP 事实上使用了一个 MLP 表示场景，与 NeRF 类似但输入仅仅是三维空间点的坐标（作者的观点是对模拟镜面反射不感兴趣），而输出同样为 RGB 和体密度。我们对于一个给定的初始相机位姿，通过 MLP 网络查询 RGB 和体密度，并渲染得到 RGB 图并计算光度误差，较 NeRF 相异的是我们的相机是 RGB-D 相机，因此我们增设一个几何损失衡量深度差异，定义为估计深度的误差，并以深度方差进行归一化因子，以二者加权和为损失，优化网络权重和相机位姿。为解决灾难性的遗忘问题， iMAP 记录以往的关键帧，择其部分加入优化。考虑到计算量较大，为实现实时运行，损失计算的时候仅选取部分的瓦块而非全部的像素。所谓的跟踪，即对相机位姿的求解，所谓映射，即对网络权重的求解。

### 关键帧选择与主动采样

关键帧选择与主动采样系较 NeRF 全然不同的部分，因而单独介绍于此。

#### 关键帧选择

我们基于信息增益选取关键帧，其基本的原理为基于当前帧较上一关键帧之差异，如果出现较多未于上一关键帧出现的信息（即区域），即加入关键帧几何，并保存当前网络快照。论文采用的方法是渲染均匀分布的一组像素，求其深度图并与锁定的快照求得的深度分布求差异并归一化，超过某个阈值则视为当前帧描述的信息较快照描述的增加较多，当低于阈值的概率低于另一个阈值的时候，视为信息增益较大，将当前帧加入关键帧。

#### 主动采样

图像主动采样采用类似从粗糙到精细的方法，先行均匀采样，在关键帧和当前帧图像采样像素计算损失，得到损失分布的先验，因应先验在损失较高的区域更多的采样。

关键帧主动采样按与图像主动采样类似的方法，在损失较高的关键帧分配更多的样本。

有界关键帧选择为了限制联合优化的计算，每次选择固定数量的关键帧（实时系统中为 $3$ 帧），而不以关键帧数目的增加而增加。
