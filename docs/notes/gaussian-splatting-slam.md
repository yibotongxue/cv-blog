---
head:
  - - link
    - rel: stylesheet
      href: https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css
---
# 高斯溅射 SLAM

本文介绍高斯溅射 SLAM （Gaussian Splatting SLAM），主要参考[论文](https://arxiv.org/abs/2312.06741)、[论文](https://arxiv.org/abs/2311.11700)、[文章](https://www.shlab.org.cn/news/5443930)和[文章](https://blog.csdn.net/weixin_45657478/article/details/135182796)。

## 三维高斯溅射

这里先介绍三维高斯溅射（3D Gaussian Splatting），因其为高斯溅射 SLAM 的基础，参考的是[论文](https://arxiv.org/abs/2308.04079)和[知乎文章](https://zhuanlan.zhihu.com/p/680669616)。

### 简介

所谓三维高斯溅射，概括的说即通过离散的、个别的三维高斯球表征场景，而通过溅射的方法渲染图像。区别于神经辐射场（NeRF）通过连续的 MLP 网络表征场景（事实上后续的改进也有以离散的若干个小的 MLP 网络表征空间场景的情事，这里指的是最初的版本），三维高斯溅射通过离散的内部连续的高斯球表示空间，取得了更高的表达能力；与神经辐射场相同的是，溅射的渲染方法同样是可微的渲染，导致了通过优化的方法取得高斯球参数成为可能，事实上三维高斯溅射也确实是这样做的，不同的在于其需要对高斯球作出离散的、不基于损失而是基于规则的调整。

### 细节介绍

以下具体介绍三维高斯建设。

#### 高斯球

所谓高斯球，实际上是对三维的高斯场的形象描述，我们知道一维的高斯函数图像为一个类似单驼峰的曲线，二维的高斯函数图像则类似一个凸起的山峰，三维的高斯场无法建立第四个维度以形象化，而是以概率区别形象化与点云，体现在三维空间则为一个椭球形状（事实上遍布全空间，椭球为其概率较高而可以被注意）。

用高斯球表示三维空间的场景，是比较容易理解的，很多文章都举如下的例子作为形象化的理解，图片取自[知乎文章](https://zhuanlan.zhihu.com/p/680669616)。

![3d-gs-game](https://pica.zhimg.com/v2-2cd7b5eb77fbef32fd9e2210025f97c6_1440w.jpg)

#### 参数

需要优化的参数都在高斯上，对于任一个高斯，论文指出了其属性包括中心位置 $\mu$ 、不透明度 $\alpha$ 、 三维协方差矩阵 $\Sigma$ 和颜色 $c$ ，这些都是作为需要优化的参数，并构成了所有的参数。形象化的理解， $\mu$ 表征了高斯球的位置， $\Sigma$ 表征了高斯球的朝向和半径等， $\alpha$ 为溅射渲染重要的参数， $c$ 使用球谐函数表示，表示颜色对视角的依赖。三维协方差矩阵也可以用旋转变换和放缩变换表示，即表示从标准高斯球到当前高斯球需要的变换，用 $R$ 表示旋转矩阵，用 $S$ 表示放缩变换，从而有以下式子成立：

$$
\Sigma = RSS^TR^T
$$

更进一步，我们注意到 $S$ 的自由度只有 $3$ ，而 $R$ 的自由度也只有 $6$ ，用 $3\times 3$ 的矩阵表示并优化并不合适，也难以保证优化得到的结果还有意义（很容易注意到 $S$ 和 $R$ 对乘法封闭，而对加法并不封闭），因应于此论文采用一个三维向量 $s$ 表示 $S$ ，而以一个四元数 $q$ 表示 $R$ 。

#### 溅射渲染

我们通过溅射的方法进行图像的渲染，其形象化的理解是将一个雪球拍到平面上，这即英文单词 Splat 的意思。

具体地说，我们通过近似是的三维高斯球在二维平面的投影仍为高斯，而其中心即为三维高斯球的中心的投影，其颜色可以通过三维高斯球的参数取得，不透明可以通过以下式子计算得到：

$$
\alpha ' = 1 - exp(-\frac{\alpha}{\sqrt{det(\Sigma)}})
$$

而投影得到的二维高斯的协方差矩阵为

$$
\Sigma ' = JW\Sigma W^TJ^T
$$

其中 $W$ 为给定的视图变换， $J$ 为射影变换的仿射近似的雅可比矩阵。

:::info
以上的数学推导很复杂，我也不是很理解，仅仅是列在这里，事实上很多时候我们只需要知道这是一个可微的渲染过程即可。
:::

:::info
上面提到了渲染是可微的，很多时候为了提高速度，往往不是使用自动微分框架进行求导，而是显式的推导出来，所以很多文章中你会看到大量的数学推导，我对这部分不是很感兴趣，本文也不会过多的涉及，我相信如果高斯溅射的应用越来越多，自动微分框架甚至硬件都会因应其进行优化。
:::

需要注意的是，我们有多个高斯球，渲染前需要进行排序，以处理其遮挡关系。对于一个渲染的区域，其可能会有多个高斯球投影，需要进行 Alpha 混合，即按照遮挡的顺序，每一个高斯球在区域的颜色乘以其不透明度与之前的透明度的乘积。

$$
C = \sum_{i\in N}c_i\alpha'_i\prod_{j=1}^{i-1}(1-\alpha'_j)
$$

这里的不透明度定义为三维高斯的不透明度与高斯的乘积

$$
\alpha'_i = \alpha_i exp(-\frac{1}{2}(x' - \mu')^T{\Sigma'}^{-1}(x' - \mu'))
$$

为了加速渲染过程，论文采用分块的方法，不是对每个像素进行高斯计算，而是分块，在每一个小块（瓦片）上进行计算。为了加速渲染过程，论文还进行了很多的设计。

取得渲染的结构后，就可以与真值图求光度误差等作为损失，从而通过优化学习参数。

#### 初始化

初始的高斯球可以通过 SfM 重构出的点云初始化，也可以随机初始化， SfM 初始化收敛会更快，但算法本身收敛速度很快，使用随机初始化也可以取得较好的效果。

#### 自适应密度控制

三维高斯球的分布可能并不合适，需要在算法进行过程中进行密度调整，主要分为：

1. 对于缺失几何特征或高斯过于分散的区域，增加高斯球密度，可以通过分裂高斯球或者克隆高斯球。评判标准为当梯度较大（超过一个阈值）的时候认为需要增加高斯密度，具体的是采用分裂高斯球或者克隆高斯球，按以下标准：
 - 方差较大的，认为为过重建，即高斯球过大，对其进行分裂
 - 方差较小的，认为为欠重建，即高斯球过小，对其进行克隆
可以参考下图，图片取自[知乎文章](https://zhuanlan.zhihu.com/p/26344567471)：

![gassian-add](https://picx.zhimg.com/v2-af2466dce220e85b64801b851e02488d_1440w.jpg)

2. 对于高斯密度不合理的过大的区域，需要消除部分高斯，一般为接近透明（即 $\alpha$ 小于一个阈值）或过大的高斯。[知乎文章](https://zhuanlan.zhihu.com/p/680669616)还提到了

 > 此外，为防止输入相机附近的高斯密度不合理地增加，这些高斯会在固定次数的迭代后，将 $\alpha$ 设置为接近0的值。该步骤在保证高斯的精度和有效性的情况下，能节约计算资源。

 但我对于这部分并不太理解。

## 高斯溅射 SLAM

这里介绍高斯溅射 SLAM 的基本内容。

### 三维高斯场景表示

同三维高斯溅射中的类似的方法，我们用离散的、个别的三维高斯球表征场景，较其不同的是，在 SLAM 问题中，我们的相机还可以取得场景中的深度信息，因而我们渲染的时候还可以渲染深度图以求几何深度损失，深度图的渲染同样采用 Alpha 混合，其公式与颜色的渲染公式除去用深度替代颜色外无其他区别。

### 跟踪

跟踪的实现，基本的思路是求解当前和上一个时刻的相机位姿，即定位问题，这是 SLAM 问题中一个基本的问题。高斯溅射 SLAM 的跟踪实现，实际上就是需要优化求解相机位姿的估计，其损失即为几何深度损失和光度误差的加权和，在跟踪阶段，我们不会更新高斯，而是仅优化相机位姿。基于相机运动连续性的假设，我们可以把当前相机位姿初始化为上一个位姿加上上一个运动的结果，这样可以加快算法收敛。

### 关键帧

使用视频流中的所有图像来联合优化高斯场景表示和相机位姿是不可行的，我们需要选择关键帧。关键帧的选择主要基于高斯分布的可见性和帧之间的重叠度，具体来说即当可见性低于某个阈值或者较上一个关键帧相对位移相对于深度中位数很大时，将当前帧注册为关键帧。所谓高斯分布可见性，即相机射线到高斯时积累的 $\alpha$ 值尚未达到 $0.5$ 时，视为该高斯在该视角下可见。为了效率，我们需要限制关键帧的数目，我们始终保留最新的两个关键帧，而对于之前的关键帧，如果其与当前关键帧的重叠系数低于某个阈值，则会被从当前窗口移除。

### 建图

#### 高斯场景优化

建图即需要对高斯场景表示进行优化，按照上面的方法，我们可以计算其几何深度损失和光度误差作为损失，除此之外，我们可以引入一个各向同性的正则化，即

$$
E_{iso} = \sum\limits_{i=1}^{|G|}|| s_i - \tilde{s_i} \cdot 1||_1
$$

以约束椭球体的伸缩，鼓励球形，避免沿观察方向高度拉长的高斯线产生的伪影问题。

#### 自适应三维高斯扩展映射

优化高斯场景表示，实际上就是 SLAM 中的建图过程。在第一帧，研究人员均匀采样一般的像素，将其方向投影到具有相应深度观测值的三维点，设置 RGB 颜色为 $0$ 阶球谐函数，根据密度设置协方差，将不透明度设置为预定义值，完成高斯球的初始化。研究人员只选择了一半的像素进行初始化，从而为自适应三维高斯扩展映射留下了空间。以下是其基本步骤：

##### 添加3D高斯步骤

与三维高斯溅射不同，高斯溅射 SLAM 添加高斯主要是在新增的观察区域进行，我们将场景渲染得到 RGB 图和深度图，将那些不透明度太低或深度估计与实际相差太大的像素标记为不可靠像素，对于这些不可靠像素，我们将其反向投影到三维点，并在三维点按照初始化方式添加新的高斯。

##### 删除3D高斯步骤

在添加了新的高斯之后，我们检查当前相机视锥中所有可见的三维高斯体，并显著降低那些位置不在场景表面附近的三维高斯体的不透明度。对于高斯球是否在场景表面附近的判断，我们可以比较该高斯球中心与相机连线与图像平面交点对应的深度值与高斯球深度值的比较实现，差距过大的认为是不在表面。

### 捆绑调整

捆绑调整（Bundle Adjustment），或称光束法平差，是 SLAM 问题一个重要的方法，其基本思路是最小化重投影误差。捆绑调整阶段，我们会在关键帧库中随机选择若干个关键帧，同时对场景表示（即高斯）和相机位姿进行优化，为了保持相机位姿的稳定，我们在上半阶段只优化场景表示，在下半阶段同时优化场景表示和相机位姿。
